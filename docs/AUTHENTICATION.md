# JWT認証の仕様

## 概要

llamune_codeは**JWT (JSON Web Token)** を使用した認証システムを実装しています。
アクセストークンとリフレッシュトークンの2種類のトークンを使用します。

---

## トークンの種類

### 1. アクセストークン (Access Token)

- **有効期限**: 15分（デフォルト）
- **用途**: APIリクエストの認証
- **保存場所**: メモリ（LocalStorage）
- **更新方法**: リフレッシュトークンで更新

### 2. リフレッシュトークン (Refresh Token)

- **有効期限**: 7日間（デフォルト）
- **用途**: アクセストークンの更新
- **保存場所**: データベース + LocalStorage
- **セキュリティ**: リフレッシュトークンローテーション

---

## セッション管理方式

### スライディング期限型（Sliding Expiration）

llamune_codeは**スライディング期限型**を採用しています。

**動作：**
```
ログイン
  → アクセストークン有効期限: 15分
  → リフレッシュトークン有効期限: 7日

15分後にAPIリクエスト
  → アクセストークンが期限切れ（401エラー）
  → リフレッシュトークンで自動更新
  → 新しいアクセストークン: さらに15分有効
  → 新しいリフレッシュトークン: さらに7日有効（期限リセット）

定期的に使用し続ける
  → リフレッシュトークンの期限が延長され続ける
  → 実質的に永続ログイン状態

7日間使用しない
  → リフレッシュトークンが期限切れ
  → 次回使用時に再ログイン必要
```

**特徴：**
- ✅ アクティブなユーザーは再ログイン不要
- ✅ 非アクティブなユーザーは自動的にログアウト
- ✅ Gmail、Slack、GitHubなど多くのSaaSと同じ方式

---

## セキュリティ機能

### リフレッシュトークンローテーション

リフレッシュトークンが使用されるたびに新しいトークンが発行され、古いトークンは無効化されます。

**メリット：**
- トークン盗難のリスク軽減
- 攻撃の早期検出
- OAuth 2.0 Security Best Practiceに準拠

**動作：**
```
リフレッシュトークン1: abc123
  ↓ 使用
新しいリフレッシュトークン2: def456 発行
  ↓
古いabc123は無効化（使用不可）
```

---

## 環境変数設定

`.env` ファイルで設定を変更できます：

```dotenv
# アクセストークンの有効期限
JWT_ACCESS_EXPIRY=15m

# リフレッシュトークンの有効期限
JWT_REFRESH_EXPIRY=7d

# JWT署名用のシークレット（本番環境では必ず変更）
JWT_SECRET=your-secret-key-here
```

**有効期限の指定形式：**
- `15m` = 15分
- `1h` = 1時間
- `7d` = 7日
- `30d` = 30日

---

## 実装の詳細

### 自動トークンリフレッシュ

Web UIでは、APIリクエストで401エラーが返されたときに自動的にリフレッシュトークンでアクセストークンを更新します。

**実装場所：**
- `web/src/hooks/useChat.ts` - チャット送信時の自動リフレッシュ
- `web/src/utils/api.ts` - 一般的なAPIリクエストの自動リフレッシュ

**ログ出力：**
```
Access token expired, refreshing...
✅ Retried with new access token
```

### トークン検証

すべての認証が必要なAPIエンドポイントは、ミドルウェアでアクセストークンを検証します。

**実装場所：**
- `src/api/middleware/jwt-auth.ts`

---

## 比較：他の認証方式

### 固定期限型（Absolute Expiration）

**例：** AWS Management Console

```
ログイン時刻: 9:00
セッション上限: 12時間

21:00まで使用可能
21:01以降は必ず再ログイン必要（使用していても）
```

**特徴：**
- セキュリティ重視
- コンプライアンス要件がある企業システム
- 定期的な再認証を強制

**llamune_codeでは採用していません。**

---

## トラブルシューティング

### 15分ごとに再ログインを求められる

**原因：** リフレッシュトークンの自動更新が動作していない

**確認：**
1. ブラウザのコンソールで「Access token expired, refreshing...」が表示されるか
2. `.env` の `JWT_REFRESH_EXPIRY` が正しく設定されているか
3. サーバーが再起動されているか（.env変更後）

### 7日以内でもログアウトされる

**原因：** リフレッシュトークンがDBから削除されている

**確認：**
1. `~/.llamune_code/history.db` の `refresh_tokens` テーブルを確認
2. 複数デバイスからログインしている場合、古いトークンが削除された可能性

---

## まとめ

- **アクセストークン**: 15分ごとに自動更新（透明）
- **リフレッシュトークン**: 使用するたびに期限リセット（7日間非アクティブでタイムアウト）
- **ユーザー体験**: 定期的に使用していれば再ログイン不要
- **セキュリティ**: トークンローテーションで保護

この方式により、セキュリティとユーザビリティのバランスを実現しています。
